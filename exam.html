<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="shortcut icon"
      href="data/images/favicon-16x16.png"
      type="image/x-icon"
    />
    <title>Quiz</title>
    <style>
      :root {
        --primary-color: #3498db;
        --secondary-color: #2980b9;
        --correct-color: #2ecc71;
        --wrong-color: #e74c3c;
        --bg-light: #f9f9f9;
        --bg-dark: #1c1c1c;
        --card-radius: 16px;
        --btn-radius: 10px;
        --transition: 0.3s;
        --font-main: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: var(--font-main);
        background: linear-gradient(135deg, #3498db 0%, #6dd5fa 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        transition: background var(--transition), color var(--transition);
        padding: 10px;
      }

      /* Buttons */
      .btn {
        position: fixed;
        padding: 10px 16px;
        font-size: 14px;
        border: none;
        border-radius: var(--btn-radius);
        cursor: pointer;
        background-color: var(--secondary-color);
        color: #fff;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        transition: background-color var(--transition);
        z-index: 1000;
      }
      .btn:hover {
        background-color: var(--primary-color);
      }

      #theme-toggle {
        top: 15px;
        right: 15px;
      }
      #questions-btn {
        top: 15px;
        left: 15px;
      }

      /* Questions Navigation */
      #questions-nav {
        position: fixed;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px;
        background-color: #fff;
        border-radius: 12px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
        gap: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        opacity: 0;
        visibility: hidden;
        transition: all var(--transition);
        z-index: 1000;
      }

      #questions-nav.show-questions-nav {
        opacity: 1;
        visibility: visible;
      }
      #questions-nav li {
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        transition: all var(--transition);
        font-weight: 600;
      }

      /* Overlay */
      body.active::before {
        content: "";
        position: fixed;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 900;
      }

      /* Container */
      .container {
        max-width: 480px;
        width: 100%;
        background-color: #fff;
        border-radius: var(--card-radius);
        padding: 30px 25px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: background-color var(--transition),
          box-shadow var(--transition);
      }

      #question-number {
        font-size: 16px;
        margin-bottom: 10px;
        color: #555;
      }

      #question-text {
        font-size: 20px;
        font-weight: 600;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-radius: 12px;
        background-color: #e3f2fd;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15);
        transition: background-color var(--transition), color var(--transition);
        user-select: none;
      }

      /* Answer buttons */
      .btn-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 15px;
      }
      .answer-btn {
        padding: 12px;
        font-size: 16px;
        border-radius: var(--btn-radius);
        border: none;
        cursor: pointer;
        background-color: var(--primary-color);
        color: #fff;
        transition: background-color var(--transition), transform 0.1s ease;
      }
      .answer-btn:hover {
        background-color: var(--secondary-color);
        transform: scale(1.02);
      }
      .answer-btn.correct {
        background-color: var(--correct-color) !important;
      }
      .answer-btn.wrong {
        background-color: var(--wrong-color) !important;
      }

      button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
      }

      /* Next button */
      #next-btn {
        margin-top: 20px;
      }

      /* Result Box */
      #result-box {
        margin-top: 20px;
        font-size: 18px;
        font-weight: 600;
        padding: 15px;
        border-radius: var(--card-radius);
        background-color: #dfefff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: all var(--transition);
      }

      /* Dark Mode */
      body.dark {
        background: linear-gradient(135deg, #181818 0%, #0c0c0c 100%);
        color: #ddd;
      }
      body.dark .container {
        background-color: var(--bg-dark);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
      }
      body.dark #question-text {
        background-color: #353535;
        color: #f0f0f0;
      }
      body.dark #questions-nav {
        background-color: #353535;
      }
      body.dark #result-box {
        background-color: #3a3a3a;
        color: #eee;
      }
      body.dark .answer-btn {
        background-color: #1b4f72;
      }
      body.dark .answer-btn:hover {
        background-color: #1c5980;
      }
      body.dark .correct {
        background-color: #27ae60;
      }
      body.dark .wrong {
        background-color: #c0392b;
      }
      body.dark button:disabled {
        background-color: #555;
      }

      /* Quran Overlay */
      #quran-overlay {
        position: fixed;
        inset: 0;
        background: rgba(248, 249, 250, 0.98);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1001;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--transition);
        padding: 15px;
        overflow-y: auto;
      }
      #quran-overlay.show {
        opacity: 1;
        pointer-events: auto;
      }
      .overlay-content {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
        max-width: 480px;
      }
      .surah {
        background-color: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }
      .surah h2 {
        margin-bottom: 10px;
        font-size: 18px;
      }
      .surah p {
        line-height: 1.8;
      }

      /* Countdown */
      #countdown {
        font-size: 22px;
        font-weight: bold;
        width: 55px;
        height: 55px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 10px;
        border-radius: 50%;
        background-color: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }

      /* Responsive */
      @media (max-width: 600px) {
        .container {
          padding: 20px;
        }
        #question-text {
          font-size: 18px;
          padding: 12px;
        }
        .answer-btn {
          font-size: 15px;
          padding: 10px;
        }
        #questions-nav {
          top: 70px;
          grid-template-columns: repeat(auto-fit, minmax(30px, 1fr));
        }
      }

      @media (max-width: 400px) {
        #countdown {
          width: 45px;
          height: 45px;
          font-size: 18px;
        }
        .container {
          padding: 15px;
        }
        .answer-btn {
          font-size: 14px;
          padding: 8px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Controls -->
    <button id="theme-toggle" class="btn">Dark mode</button>
    <button id="questions-btn" class="btn">Questions</button>
    <ul id="questions-nav"></ul>

    <!-- Quiz Container -->
    <div class="container">
      <!-- Quran Overlay -->
      <div id="quran-overlay">
        <div class="overlay-content">
          <div id="countdown">20</div>
          <div class="surah">
            <h2>﷽ سورة الإخلاص</h2>
            <p>قُلْ هُوَ اللَّهُ أَحَدٌ ﴿١﴾ ...</p>
          </div>
          <div class="surah">
            <h2>﷽ سورة الفلق</h2>
            <p>قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ ﴿١﴾ ...</p>
          </div>
          <div class="surah">
            <h2>﷽ سورة الناس</h2>
            <p>قُلْ أَعُوذُ بِرَبِّ النَّاسِ ﴿١﴾ ...</p>
          </div>
        </div>
      </div>

      <!-- Quiz -->
      <h2 id="quiz-title"></h2>
      <div id="start-box"><button id="start-btn">Start</button></div>

      <div id="quiz-box" class="hide">
        <div id="question-number"></div>
        <div id="question-text"></div>
        <div id="answer-buttons" class="btn-grid"></div>
        <button id="next-btn" disabled>Next</button>
      </div>

      <!-- Result -->
      <div id="result-box" class="hide">
        <h3>Your Score</h3>
        <p id="score-text"></p>
        <button id="try-again-btn">Try Again</button>
        <button id="home-btn">Home</button>
      </div>
    </div>

    <script>
      /* Global Variables */
      let allQuestions = [];
      let answersState = [];
      let currentQuestionIndex = 0;
      let score = 0;

      const params = new URLSearchParams(window.location.search);
      const file = params.get("file");

      /* DOM Elements */
      const homeBtn = document.getElementById("home-btn");
      const startBtn = document.getElementById("start-btn");
      const nextBtn = document.getElementById("next-btn");
      const tryAgainBtn = document.getElementById("try-again-btn");

      const quizBox = document.getElementById("quiz-box");
      const startBox = document.getElementById("start-box");
      const resultBox = document.getElementById("result-box");

      const questionNumberElement = document.getElementById("question-number");
      const questionText = document.getElementById("question-text");
      const answerButtons = document.getElementById("answer-buttons");
      const scoreText = document.getElementById("score-text");

      const themeToggleBtn = document.getElementById("theme-toggle");
      const questionsBtn = document.getElementById("questions-btn");
      const questionsNav = document.getElementById("questions-nav");

      const quranOverlay = document.getElementById("quran-overlay");
      const countdown = document.getElementById("countdown");

      /* Load JSON file */
      if (file) {
        fetch(file)
          .then((res) => res.json())
          .then((data) => {
            allQuestions = data.questions || [];
            answersState = allQuestions.map(() => ({
              answered: false,
              correct: null,
              chosenIndex: null,
            }));
            buildQuestionsNav();
            const examTitle = data.title || data.examTitle || "Exam";
            document.getElementById("quiz-title").textContent = examTitle;
            startBtn.addEventListener("click", startQuiz);
          })
          .catch((err) => console.error("Error loading exam file:", err));
      }

      /* Build Navigation */
      function buildQuestionsNav() {
        questionsNav.innerHTML = "";
        allQuestions.forEach((q, index) => {
          const li = document.createElement("li");
          li.textContent = index + 1;
          li.addEventListener("click", (e) => {
            e.stopPropagation();
            currentQuestionIndex = index;
            setNextQuestion();
            questionsNav.classList.remove("show-questions-nav");
            document.body.classList.remove("active");
          });
          questionsNav.appendChild(li);
        });
      }

      function highlightCurrentNav() {
        const items = questionsNav.querySelectorAll("li");
        items.forEach((li, i) => {
          li.style.backgroundColor = "";
          li.style.color = "";
          if (!answersState[i].answered) return;
          if (answersState[i].correct) {
            li.style.backgroundColor = "#2ecc71";
            li.style.color = "#fff";
          } else {
            li.style.backgroundColor = "#e74c3c";
            li.style.color = "#fff";
          }
          if (i === currentQuestionIndex) {
            li.style.backgroundColor = "#3498db";
            li.style.color = "#fff";
          }
        });
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      function showQuranOverlay(callback) {
        quranOverlay.classList.add("show");
        let timeLeft = 30;
        countdown.textContent = timeLeft;
        let timer = setInterval(() => {
          timeLeft--;
          countdown.textContent = timeLeft;
          if (timeLeft <= 0) {
            clearInterval(timer);
            quranOverlay.classList.remove("show");
            callback && callback();
          }
        }, 1000);
      }

      questionsBtn.onclick = function (e) {
        e.stopPropagation();
        questionsNav.classList.toggle("show-questions-nav");
        document.body.classList.toggle("active");
      };
      document.addEventListener("click", () => {
        questionsNav.classList.remove("show-questions-nav");
        document.body.classList.remove("active");
      });
      homeBtn.addEventListener("click", () => {
        window.location.href = "https://kaya-benha-nursing.netlify.app/";
      });
      themeToggleBtn.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        themeToggleBtn.textContent = document.body.classList.contains("dark")
          ? "Light mode"
          : "Dark mode";
      });

      startBtn.addEventListener("click", () => {
        startBox.classList.add("hide");
        showQuranOverlay(() => {
          quizBox.classList.remove("hide");
          setNextQuestion();
        });
      });
      nextBtn.addEventListener("click", () => {
        currentQuestionIndex++;
        setNextQuestion();
      });
      tryAgainBtn.addEventListener("click", startQuiz);

      function startQuiz() {
        currentQuestionIndex = 0;
        score = 0;
        shuffleArray(allQuestions);
        answersState = allQuestions.map(() => ({
          answered: false,
          correct: null,
          chosenIndex: null,
        }));
        startBox.classList.add("hide");
        resultBox.classList.add("hide");
        quizBox.classList.remove("hide");
        setNextQuestion();
      }

      function setNextQuestion() {
        resetState();
        if (currentQuestionIndex < allQuestions.length) {
          showQuestion(allQuestions[currentQuestionIndex]);
          highlightCurrentNav();
          nextBtn.textContent =
            currentQuestionIndex === allQuestions.length - 1
              ? "Show Result"
              : "Next";
          nextBtn.disabled = !answersState[currentQuestionIndex].answered;
        } else {
          const firstUnanswered = answersState.findIndex((q) => !q.answered);
          if (firstUnanswered !== -1) {
            currentQuestionIndex = firstUnanswered;
            setNextQuestion();
          } else {
            showResult();
          }
        }
      }

      function showQuestion(questionObj) {
        questionNumberElement.textContent = `Question ${
          currentQuestionIndex + 1
        } of ${allQuestions.length}`;
        questionText.textContent = questionObj.question;
        let optionsWithFlag = questionObj.options.map((opt, i) => ({
          text: opt,
          isCorrect: i === questionObj.correctIndex,
          index: i,
        }));
        if (
          optionsWithFlag.length !== 2 ||
          !optionsWithFlag.includes("True") ||
          !optionsWithFlag.includes("False")
        ) {
          const fixedOptions = [
            "All of the above",
            "All are true",
            "All are false",
            "All are correct",
            "All of the answers are correct",
            "All of the answers are recommended",
            "None of the above",
          ];
          const fixedIndex = optionsWithFlag.findIndex((opt) =>
            fixedOptions.includes(opt.text.trim())
          );
          if (fixedIndex !== -1) {
            const fixedOption = optionsWithFlag.splice(fixedIndex, 1)[0];
            shuffleArray(optionsWithFlag);
            optionsWithFlag.push(fixedOption);
          } else {
            shuffleArray(optionsWithFlag);
          }
        }
        optionsWithFlag.forEach((option) => {
          const button = document.createElement("button");
          button.textContent = option.text;
          button.classList.add("answer-btn");
          if (answersState[currentQuestionIndex].answered) {
            button.disabled = true;
            if (option.isCorrect) button.classList.add("correct");
            if (
              answersState[currentQuestionIndex].chosenIndex === option.index &&
              !option.isCorrect
            )
              button.classList.add("wrong");
          } else {
            button.addEventListener("click", () =>
              selectAnswer(button, option.isCorrect, option.index)
            );
          }
          answerButtons.appendChild(button);
        });
      }

      function resetState() {
        nextBtn.disabled = true;
        answerButtons.innerHTML = "";
      }

      function selectAnswer(button, isCorrect, chosenIndex) {
        const buttons = answerButtons.querySelectorAll("button");
        buttons.forEach((btn) => (btn.disabled = true));
        if (isCorrect) {
          button.classList.add("correct");
          score++;
          answersState[currentQuestionIndex] = {
            answered: true,
            correct: true,
            chosenIndex,
          };
        } else {
          button.classList.add("wrong");
          buttons.forEach((btn) => {
            if (
              btn.textContent ===
              allQuestions[currentQuestionIndex].options[
                allQuestions[currentQuestionIndex].correctIndex
              ]
            )
              btn.classList.add("correct");
          });
          answersState[currentQuestionIndex] = {
            answered: true,
            correct: false,
            chosenIndex,
          };
        }
        highlightCurrentNav();
        nextBtn.disabled = false;
      }

      function showResult() {
        showQuranOverlay(() => {
          quizBox.classList.add("hide");
          resultBox.classList.remove("hide");
          scoreText.textContent = `${score} out of ${allQuestions.length}`;
        });
      }
    </script>
  </body>
</html>
